# üõ°Ô∏è Phishing Detector Multimodal

Detector de phishing bancario que aprovecha las **capacidades multimodales de LLMs avanzados** para analizar texto e im√°genes simult√°neamente, con **threat intelligence en tiempo real**, **an√°lisis de attachments** y **b√∫squeda web inteligente**.

## üöÄ Caracter√≠sticas

- **üß† An√°lisis multimodal**: El LLM analiza texto + im√°genes en una sola pasada
- **üõ°Ô∏è Threat Intelligence**: Descarga autom√°tica de dominios maliciosos de m√∫ltiples fuentes
- **üìé An√°lisis de attachments**: Detecci√≥n avanzada de malware y archivos peligrosos
- **üåê B√∫squeda web inteligente**: Verificaci√≥n de reputaci√≥n y antecedentes online
- **üè¶ Especializado en bancos espa√±oles**: Conoce logos y dominios oficiales
- **üéØ Detecci√≥n inteligente**: Identifica logos falsos, dominios sospechosos y patrones de phishing
- **‚ö° Simple y directo**: Sin infraestructura compleja, solo el poder del LLM
- **üìä Reportes detallados**: An√°lisis estructurado con niveles de confianza
- **üîß M√∫ltiples interfaces**: CLI, API REST, interfaz web

## üß† C√≥mo Funciona

A diferencia de sistemas tradicionales que usan m√∫ltiples herramientas, este detector:

1. **Extrae autom√°ticamente** las im√°genes embebidas del email
2. **Env√≠a texto + im√°genes** al LLM multimodal 
3. **El LLM analiza todo junto** detectando inconsistencias visuales y textuales
4. **Devuelve an√°lisis estructurado** en JSON con recomendaciones claras

## üìã Requisitos

- Python 3.9+
- API key de un LLM con capacidades multimodales:
  - **GPT-4 Vision** (OpenAI)
  - **GPT-4o** (OpenAI) 
  - **Claude 3** (Anthropic)
  - Cualquier modelo compatible con formato OpenAI

## üìã Instalaci√≥n

### 1. Clonar Repositorio
```bash
git clone <repo-url>
cd phishing_detector
```

### 2. Crear Entorno Virtual (Recomendado)
```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
# o
venv\Scripts\activate     # Windows
```

### 3. Instalar Dependencias
```bash
pip install -r requirements.txt
```

### 4. Configurar Variables de Entorno
Crear archivo `.env` en la ra√≠z del proyecto:

```env
# === REQUERIDO ===
OPENAI_API_KEY="tu_clave_openai_aqui"

# === OPCIONAL PERO RECOMENDADO ===
# Para modelos espec√≠ficos
MODEL_NAME="gpt-4-vision-preview"  # o "gpt-4o"
OPENAI_API_BASE="https://api.openai.com/v1"

# Para threat intelligence mejorado
PHISHTANK_API_KEY="tu_clave_phishtank"

# Para b√∫squeda web inteligente
BRAVE_API_KEY="tu_clave_brave"

# === CONFIGURACI√ìN GENERAL ===
LOG_LEVEL="INFO"
ENVIRONMENT="development"
```

### 5. Verificar Instalaci√≥n
```bash
python -m app.main --email-file data/example_phishing_email.txt
```

---

## ‚ö° Inicio R√°pido

**¬øPrimera vez? Las opciones m√°s comunes:**

```bash
# üéØ M√ÅS SIMPLE: Solo interfaz web
python -m streamlit run app/streamlit_app.py
# Luego ve a: http://localhost:8501

# üöÄ COMPLETO: API + Web (si run.py funciona)
python run.py

# üíª L√çNEA DE COMANDOS: Para scripts y automatizaci√≥n  
python -m app.main --email-file data/example_phishing_email.txt

# üîß SOLO API: Para integraciones
python -m uvicorn app.api:app --host 0.0.0.0 --port 8000
```

---

## üöÄ Opciones de Lanzamiento Detalladas

### **1. üåê Interfaz Web Completa (Recomendado)**
**Inicia API + Interfaz Web + Abre navegador autom√°ticamente**

```bash
cd phishing_detector
python run.py
```

**Servicios disponibles:**
- üñ•Ô∏è **Interfaz Web**: `http://localhost:8501`
- üîß **API REST**: `http://localhost:8000`
- üìö **Documentaci√≥n API**: `http://localhost:8000/docs`

**Caracter√≠sticas:**
- ‚úÖ Upload de emails y attachments
- ‚úÖ Visualizaci√≥n interactiva de resultados
- ‚úÖ An√°lisis por tabs (Texto, Im√°genes, Dominios, Attachments)
- ‚úÖ Exportaci√≥n de resultados

---

### **2. üì± Solo Interfaz Web (Streamlit)**
**Para desarrollo o uso personal**

```bash
cd phishing_detector
python -m streamlit run app/streamlit_app.py
```

**Acceso:** `http://localhost:8501`

**Ventajas:**
- üé® Interfaz amigable y visual
- üì§ Upload directo de archivos
- üìä Gr√°ficos y m√©tricas en tiempo real
- üîÑ An√°lisis interactivo

---

### **3. üîß Solo API REST (FastAPI)**
**Para integraciones y desarrollo de aplicaciones**

```bash
cd phishing_detector
python -m uvicorn app.api:app --host 0.0.0.0 --port 8000 --reload
```

**Endpoints principales:**
- `POST /analyze/` - An√°lisis completo
- `POST /analyze/file/` - Upload de archivos
- `GET /health` - Estado del sistema
- `GET /docs` - Documentaci√≥n interactiva

**Ejemplo de uso:**
```bash
curl -X POST "http://localhost:8000/analyze/" \
     -H "Content-Type: application/json" \
     -d '{"text": "Email sospechoso aqu√≠", "images": []}'
```

---

### **4. üíª L√≠nea de Comandos (CLI)**
**Para automatizaci√≥n y an√°lisis por lotes**

#### An√°lisis B√°sico
```bash
cd phishing_detector
python -m app.main --email-file data/example_phishing_email.txt
```

#### An√°lisis Completo con Todas las Funcionalidades
```bash
python -m app.main --email-file data/example_phishing_email.txt --enhanced
```

#### Solo Clasificaci√≥n
```bash
python -m app.main --email-file data/example_phishing_email.txt --simple
```

#### Guardar Resultado en JSON
```bash
python -m app.main --email-file data/example_phishing_email.txt --output-file resultado.json
```

#### Modo Verbose (Debugging)
```bash
python -m app.main --email-file data/example_phishing_email.txt --verbose
```

#### Opciones Espec√≠ficas
```bash
# Solo threat intelligence
python -m app.main --email-file email.txt --threat-intel-only

# Solo an√°lisis de attachments
python -m app.main --email-file email.txt --attachments-only

# Sin b√∫squeda web (m√°s r√°pido)
python -m app.main --email-file email.txt --no-web-search
```

---

### **5. üêç Uso Program√°tico**
**Para integraci√≥n en otros proyectos Python**

#### An√°lisis B√°sico
```python
import asyncio
from app.agent.multimodal_phishing_agent import MultimodalPhishingAgent

async def analyze_basic():
    agent = MultimodalPhishingAgent()
    
    with open('email.txt', 'r') as f:
        email_content = f.read()
    
    result = await agent.analyze_email(email_content)
    print(f"Clasificaci√≥n: {result.get('classification')}")

asyncio.run(analyze_basic())
```

#### An√°lisis Completo con Todas las Funcionalidades
```python
import asyncio
from app.agent.enhanced_multimodal_agent import EnhancedMultimodalPhishingAgent

async def analyze_enhanced():
    agent = EnhancedMultimodalPhishingAgent()
    
    with open('email.txt', 'r') as f:
        email_content = f.read()
    
    # An√°lisis completo
    result = await agent.analyze_email_comprehensive(
        email_content=email_content,
        perform_web_search=True,
        check_threat_intel=True
    )
    
    print(f"Clasificaci√≥n: {result['enhanced_classification']}")
    print(f"Confianza: {result['confidence']*100:.1f}%")
    print(f"Fuentes: {result['sources_used']}")
    
    # Reporte legible
    report = await agent.get_enhanced_report(email_content)
    print(report)

asyncio.run(analyze_enhanced())
```

#### Configuraci√≥n Personalizada
```python
config = {
    "threat_intelligence": {
        "custom_threat_sources": [
            {
                "name": "mi_empresa",
                "url": "https://mi-empresa.com/blacklist.txt",
                "update_frequency": 1800
            }
        ]
    },
    "web_search": {
        "brave_api_key": "tu_key",
        "max_search_results": 10
    }
}

agent = EnhancedMultimodalPhishingAgent(config)
```

---

## üîß Soluci√≥n de Problemas

### **Error: "OPENAI_API_KEY environment variable"**
```bash
# Soluci√≥n 1: Crear archivo .env
echo 'OPENAI_API_KEY="tu_clave_aqui"' > .env

# Soluci√≥n 2: Exportar variable
export OPENAI_API_KEY="tu_clave_aqui"

# Soluci√≥n 3: Pasar en tiempo de ejecuci√≥n
OPENAI_API_KEY="tu_clave" python -m app.main --email-file email.txt
```

### **Error: "Import magic could not be resolved"**
```bash
# En Linux/Ubuntu
sudo apt-get install libmagic1
pip install python-magic

# En macOS
brew install libmagic
pip install python-magic

# En Windows
pip install python-magic-bin
```

### **Error: "FileNotFoundError" en run.py**
```bash
# Verificar que est√°s en el directorio correcto
cd phishing_detector
pwd  # Debe mostrar .../phishing_detector

# Si run.py da problemas, ejecutar servicios individualmente:

# Terminal 1: API REST
python -m uvicorn app.api:app --host 0.0.0.0 --port 8000 --reload

# Terminal 2: Interfaz Web  
python -m streamlit run app/streamlit_app.py --server.port 8501

# O usar alternativas m√°s simples:
# Solo Streamlit (m√°s com√∫n)
python -m streamlit run app/streamlit_app.py

# Solo CLI (sin interfaz web)
python -m app.main --email-file data/example_phishing_email.txt
```

### **Error: "AppImage" o archivos no encontrados**
```bash
# Si aparecen errores relacionados con Cursor o AppImage:
# Esto suele ser un problema de configuraci√≥n del editor, no del c√≥digo

# Soluci√≥n 1: Limpiar variables de entorno
unset EDITOR
unset VISUAL

# Soluci√≥n 2: Ejecutar desde terminal limpio
bash --noprofile --norc
cd /ruta/completa/a/phishing_detector
python run.py

# Soluci√≥n 3: Usar m√©todos alternativos (recomendado)
python -m streamlit run app/streamlit_app.py
```

### **Puertos Ocupados**
```bash
# Verificar puertos en uso
lsof -i :8000  # API
lsof -i :8501  # Streamlit

# Matar procesos si es necesario
kill -9 $(lsof -t -i:8000)
kill -9 $(lsof -t -i:8501)

# Usar puertos alternativos
python -m uvicorn app.api:app --port 8080
python -m streamlit run app/streamlit_app.py --server.port 8502
```

### **Problema con Dependencias**
```bash
# Reinstalar todo limpio
pip uninstall -y -r requirements.txt
pip install -r requirements.txt

# O crear entorno nuevo
python -m venv venv_nuevo
source venv_nuevo/bin/activate
pip install -r requirements.txt
```

---

## üìä Ejemplos de Uso

### **An√°lisis de Email con Attachments**
```bash
python -m app.main --email-file email_con_attachments.eml --enhanced
```

### **An√°lisis por Lotes**
```bash
for email in emails/*.txt; do
    python -m app.main --email-file "$email" --output-file "results/$(basename $email .txt).json"
done
```

### **Servidor de Producci√≥n**
```bash
python -m uvicorn app.api:app --host 0.0.0.0 --port 8000 --workers 4
```

---

## üéØ APIs Externas (Opcionales)

### **OpenAI (Requerido)**
- **Obtener**: https://platform.openai.com/api-keys
- **Costo**: ~$0.01-0.03 por an√°lisis
- **Variable**: `OPENAI_API_KEY`

### **PhishTank (Recomendado)**
- **Obtener**: https://www.phishtank.com/api_info.php
- **Costo**: Gratuito
- **Variable**: `PHISHTANK_API_KEY`

### **Brave Search (Recomendado)**
- **Obtener**: https://api.search.brave.com/
- **Costo**: Gratuito hasta 2000 queries/mes
- **Variable**: `BRAVE_API_KEY`

---

## üöÄ Modo de Desarrollo

```bash
# Con recarga autom√°tica
python -m uvicorn app.api:app --reload
python -m streamlit run app/streamlit_app.py

# Con debugging
LOG_LEVEL=DEBUG python -m app.main --email-file email.txt --verbose

# Ejecutar tests (si existen)
python -m pytest tests/
```

---

## üìÅ Estructura del Proyecto

```
phishing_detector/
‚îú‚îÄ‚îÄ run.py                 # Lanzador principal
‚îú‚îÄ‚îÄ requirements.txt       # Dependencias
‚îú‚îÄ‚îÄ .env                   # Variables de entorno
‚îú‚îÄ‚îÄ README.md             # Esta documentaci√≥n
‚îú‚îÄ‚îÄ ENHANCED_FEATURES.md  # Funcionalidades avanzadas
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ main.py           # CLI principal
‚îÇ   ‚îú‚îÄ‚îÄ api.py            # API REST
‚îÇ   ‚îú‚îÄ‚îÄ streamlit_app.py  # Interfaz web
‚îÇ   ‚îú‚îÄ‚îÄ agent/            # Agentes de an√°lisis
‚îÇ   ‚îú‚îÄ‚îÄ tools/            # Herramientas especializadas
‚îÇ   ‚îú‚îÄ‚îÄ data_sources/     # Fuentes de threat intelligence
‚îÇ   ‚îî‚îÄ‚îÄ utils/            # Utilidades
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îú‚îÄ‚îÄ example_*.txt     # Emails de ejemplo
‚îÇ   ‚îî‚îÄ‚îÄ cache/            # Cache de threat intelligence
‚îî‚îÄ‚îÄ config.py             # Configuraci√≥n central
```

---

## üí° Recomendaciones de Uso

### **Para Empezar**
1. **Usar interfaz web**: `python run.py`
2. **Probar con ejemplos**: Usar archivos en `data/`
3. **Verificar APIs**: Comprobar que las claves funcionen

### **Para Producci√≥n**
1. **Configurar APIs externas** para m√°xima precisi√≥n
2. **Usar worker m√∫ltiples** en uvicorn
3. **Monitorizar logs** para detectar problemas
4. **Configurar cache** para optimizar rendimiento

### **Para Desarrollo**
1. **Modo verbose** para debugging
2. **API reload** para cambios en caliente
3. **Tests unitarios** para validar cambios 